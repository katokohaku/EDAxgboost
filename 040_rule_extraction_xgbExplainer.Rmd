---
author: "Satoshi Kato"
title: "rule extraction from xgboost model"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document:
    fig_caption: yes
    pandoc_args:
      - --from
      - markdown+autolink_bare_uris+tex_math_single_backslash-implicit_figures
    keep_md: yes
    toc: yes
  word_document:
    toc: yes
    toc_depth: 3
  pdf_document:
    toc: yes
    toc_depth: 3
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_knit$set(progress = TRUE, 
                     verbose  = TRUE, 
                     root.dir = ".")

knitr::opts_chunk$set(collapse = FALSE, 
                      comment = "", 
                      message = TRUE, 
                      warning = FALSE, 
                      include = TRUE,
                      echo    = TRUE)

set.seed(1)
```

```{r install.requirements, eval = FALSE}
install.packages("devtools", dependencies = TRUE)
devtools::install_github("AppliedDataSciencePartners/xgboostExplainer")

install.packages("ggridges", dependencies = TRUE)

```

```{r require.packages, message=FALSE}
require(tidyverse)
require(magrittr)
require(data.table)
require(xgboost)
require(xgboostExplainer)
require(ggridges)


```

# Preparation 

```{r load.model.and.data}
loaded.obs  <- readRDS("./middle/data_and_model.Rds")

model.xgb   <- loaded.obs$model$xgb 

train.label <- loaded.obs$data$train$label
train.matrix <- loaded.obs$data$train$matrix
train.xgb.DMatrix <- xgb.DMatrix("./middle/train.xgbDMatrix")

test.label  <- loaded.obs$data$test$label
test.matrix <- loaded.obs$data$test$matrix
test.xgb.DMatrix  <- xgb.DMatrix("./middle/test.xgbDMatrix")

```

# Preditive result of All

In this case, eval_metrics were high enough, therefore, we use test data for following evaluation

```{r}
test.pred <- predict(model.xgb, test.xgb.DMatrix)

prediction.counts <- table(test.pred, test.label) %>% 
  data.frame %>%
  mutate(
    predict = substr(test.pred, start = 1, stop = 4),
    count   = ifelse(test.label == "0", Freq, -Freq)) 

prediction.counts %>% 
  ggplot(aes(x =  reorder(predict, -as.numeric(predict)),
             y = count, 
             fill = test.label)) +
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x = "prediction") +
  ggtitle(sprintf("%i rules of %i instance was extracted", 
                  NROW(prediction.counts), NROW(test.pred)))

```

# Feature pruning

Target features are filterd using `xgb.importance()`

```{r}
var.imp <- xgb.importance(model = model.xgb,
                          feature_names = dimnames(train.xgb.DMatrix)[[2]])

var.imp %>% mutate_if(is.numeric, round, digits = 4)
target.feature <- var.imp$Feature %>% head(5)
target.feature

train.selected <- loaded.obs$data$train$dummy.data.frame %>% 
  select(target.feature)
  
train.selected.xgb.DMatrix <- xgb.DMatrix(data  = as.matrix(train.selected),
                                          label = train.label)

test.selected <- loaded.obs$data$test$dummy.data.frame %>% 
  select(target.feature) 
test.selected.xgb.DMatrix <- xgb.DMatrix(data  = as.matrix(test.selected),
                                         label = test.label)

```

## rebuild XGB model

```{r}
param.set <- loaded.obs$model$param.set
param.set$alpha <- 0.8
param.set$max_depth <- 3
set.seed(1)
cv <- xgb.cv(params  = param.set, 
             verbose = 1,
             data    = train.selected.xgb.DMatrix,
             nrounds = 200,
             nfold   = 5,
             early_stopping_rounds = 5)

cv$evaluation_log %>% 
  select(-ends_with("_std")) %>% 
  tidyr::gather(key = data, value = auc, train_auc_mean, test_auc_mean) %>%
  ggplot(aes(x = iter, y = auc, color = as.factor(data))) +
  geom_line() +
  geom_vline(xintercept = cv$niter)


```

```{r}
model.selected.xgb <- xgb.train(params  = loaded.obs$model$param.set, 
                       verbose = 1,
                       data    = train.selected.xgb.DMatrix,
                       nrounds = cv$niter)

model.selected.xgb
```

## predictive performance for test set

```{r}
test.selected.pred <- predict(model.selected.xgb, test.selected.xgb.DMatrix)
table(pred = ifelse(test.selected.pred > 0.5, 1, 0), test.label) %>% 
  caret::confusionMatrix()

# length(pred)
prediction.counts <- table(pred = test.selected.pred, test.label) %>% 
  data.frame %>% 
  mutate(
    predict   = substr(pred, start = 1, stop = 4),
    count.log = ifelse(test.label == "0", (Freq), -(Freq))) %>% 
  filter(Freq >0 )

prediction.counts %>% 
  ggplot(aes(x = reorder(predict, as.numeric(predict)),
             y = count.log, 
             fill = test.label)) +
  geom_bar(stat="identity") +
  coord_flip() +
  labs(x = "prediction", y = "count") +
  ggtitle(sprintf("%i rules of %i instance was extracted", 
                  NROW(prediction.counts), NROW(test.pred)))

```

# view rules

## Using xgboostExplainer

see https://medium.com/applied-data-science/new-r-package-the-xgboost-explainer-51dd7d1aa211

```{r, results="hide", message=FALSE}
explainer.xgb <-  buildExplainer(xgb.model    = model.selected.xgb, 
                                 trainingData = test.selected.xgb.DMatrix, 
                                 type         = "binary",
                                 base_score   = 0.5,
                                 trees_idx    = NULL)

```

## explain test set

```{r, results="hide", message=FALSE}
xgb.breakdown <- explainPredictions(xgb.model = model.selected.xgb,
                                    explainer = explainer.xgb,
                                    data      = test.selected.xgb.DMatrix)
unique.explanation <- xgb.breakdown %>% 
  rownames_to_column("id") %>%
  mutate(id = as.integer(id)) %>% 
  distinct(satisfaction_level, time_spend_company, number_project,
           last_evaluation, average_montly_hours, .keep_all = TRUE)
 
unique.explanation %>% str
```


## explain single observation

```{r, results="hide", message=FALSE}
sw <- showWaterfall(
  idx = 1,
  xgb.model   = model.selected.xgb, 
  explainer   = explainer.xgb, 
  DMatrix     = test.selected.xgb.DMatrix, 
  data.matrix = as.matrix(test.selected))

ggsave(sw, filename = "output/image.files/040_explain_single_obs.png")

```

## view all rules

```{r}
weight <- rowSums(unique.explanation[, -1])
prediction <- 1/(1 + exp(-weight))

unique.explanation %>%
  mutate(pred = prediction) %>% 
  select(pred, satisfaction_level:average_montly_hours) %>% 
  set_colnames(c("pred", "s.lev", "time.c", "n.pj", "l.eval", "monthly")) %>% 
  arrange(pred, s.lev, time.c) %>% 
  round(digits = 4)


```

![single observation](output/image.files/040_explain_single_obs.png)

```{r, eval=FALSE}
if(!dir.exists("./output/040_plot_all_rules/")){
  dir.create("./output/040_plot_all_rules/")
}
rules <- unique.explanation$id

for(i in 1:length(rules)){
  
  ggp.sw <- showWaterfall(
    idx = rules[i],
    xgb.model   = model.selected.xgb, 
    explainer   = explainer.xgb, 
    DMatrix     = test.selected.xgb.DMatrix, 
    data.matrix = as.matrix(test.selected)) +
    ggtitle(sprintf("prediction = %.04f (weight = %.04f)",
                    prediction[i], weight[i]))
  
  ggsave(ggp.sw, height = 4, width = 4,
         filename = sprintf("./output/040_plot_all_rules/%f.png", 
                                    prediction[i]))
}
```

## clustering of extracted rules

```{r clustering}
rules.hc <- unique.explanation %>% 
  select(-id, intercept) %>% 
  mutate(pred = prediction) %>% 
  dist %>%
  hclust(method = "ward.D2") 

cut.off = 0.7
png(filename = "./output/image.files/040_rules_hclust.png",
    width = 800, height = 2400)

rules.hc %>%
  as.dendrogram() %>% 
plot(type = "triangle", xlab = "Height", horiz = TRUE, lwd = 2)

abline(v = cut.off, col = "red", lty = 3, lwd = 3)

dev.off()

```
![Hierarchical Clustering of rule patterns](./output/image.files/040_rules_hclust.png)

## clustering by cutree

```{r}
member.id <- data.frame(
  id      = unique.explanation$id,
  weight  = weight,
  predict = prediction,
  member  = cutree(rules.hc, h = cut.off)) %>% 
  arrange(member)

member.id %>% 
  group_by(member) %>%
  summarise(n = n(), mean = mean(predict), sd = sd(predict)) %>% 
  arrange(mean)

```

```{r, eval=FALSE}
target <- member.id %>% filter(member == 2) 
sw <- list(NULL)

i=1
for(i in 1:NROW(target)){
  
  sw[[i]] <- showWaterfall(
    idx = target$id[i],
    xgb.model   = model.selected.xgb, 
    explainer   = explainer.xgb, 
    DMatrix     = test.selected.xgb.DMatrix, 
    data.matrix = as.matrix(test.selected)) +
    ggtitle(sprintf("predict = %.04f\nweight = %.04f",
                    target$predict[i], target$weight[i]))
}

ggp.sw <- gridExtra::grid.arrange(grobs = sw, ncol = 3)
ggsave(ggp.sw, filename = "./output/image.files/040_rules_cl2.png",
       height = 9)
```

![member of 2](./output/image.files/040_rules_cl2.png)

```{r, eval=FALSE}
target <- member.id %>% filter(member == 4) 
sw <- list(NULL)

i=1
for(i in 1:NROW(target)){
  
  sw[[i]] <- showWaterfall(
    idx = target$id[i],
    xgb.model   = model.selected.xgb, 
    explainer   = explainer.xgb, 
    DMatrix     = test.selected.xgb.DMatrix, 
    data.matrix = as.matrix(test.selected)) +
    ggtitle(sprintf("predict = %.04f\nweight = %.04f",
                    target$predict[i], target$weight[i]))
}

ggp.sw <- gridExtra::grid.arrange(grobs = sw, ncol = 4)
ggsave(ggp.sw, filename = "./output/image.files/040_rules_cl4.png", 
       height = 9, width = 7)
```

![member of 4](./output/image.files/040_rules_cl4.png)


